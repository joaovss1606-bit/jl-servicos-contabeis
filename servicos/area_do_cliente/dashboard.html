<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Cliente | JL Serviços</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #bd9617; --dark-blue: #0a192f; --glass: rgba(255, 255, 255, 0.05); }
        body { background: var(--dark-blue); color: white; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; }
        .sidebar { width: 250px; height: 100vh; background: rgba(0,0,0,0.3); border-right: 1px solid rgba(189, 150, 23, 0.2); padding: 30px 20px; display: flex; flex-direction: column; position: sticky; top: 0; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .welcome-section h1 { font-family: 'Playfair Display', serif; font-size: 2.2rem; margin: 0; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .card { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; transition: 0.3s; }
        .card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .card i { font-size: 2rem; color: var(--gold); margin-bottom: 15px; display: block; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .btn-action { background: var(--gold); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: 600; }
        .logout-btn { margin-top: auto; color: #ff4444; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .doc-item { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px; }
        .service-item { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-cancel { background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid #ff4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.3s; }
        .btn-cancel:hover { background: rgba(255, 68, 68, 0.3); }
        .status-cancelado { color: #ff4444; text-decoration: line-through; opacity: 0.7; }
        .modal-cancelar { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 10000; }
        .modal-cancelar.active { display: flex; }
        .modal-content-cancel { background: rgba(10, 25, 47, 0.95); border: 2px solid #bd9617; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; }
        .modal-content-cancel h2 { color: #bd9617; margin-top: 0; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 25px; }
        .modal-btn-confirm { background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 600; }
        .modal-btn-cancel { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 600; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color: var(--gold); font-family: 'Playfair Display';">JL Painel</h2>
        <nav style="margin-top: 40px;">
            <p style="font-size: 0.8rem; color: #888;">Navegação</p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <a href="../../index.html" style="color: #fff; text-decoration: none;"><i class="fas fa-home"></i> Voltar ao Site</a>
                <a href="#" style="color: var(--gold); text-decoration: none;"><i class="fas fa-columns"></i> Dashboard</a>
            </div>
        </nav>
        <a onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair do Painel</a>
    </aside>

    <main class="main-content">
        <section class="welcome-section">
            <h1 id="user-name">Carregando...</h1>
            <p id="user-email" style="color: #888;"></p>
        </section>

        <div class="dashboard-grid">
            <div class="card">
                <i class="fas fa-id-card"></i>
                <h3>Seus Serviços</h3>
                <div id="lista-servicos" style="max-height: 300px; overflow-y: auto;">
                    <p style="font-size: 0.8rem; color: #888;">Buscando pedidos...</p>
                </div>
            </div>

            <div class="card">
                <i class="fas fa-folder-open"></i>
                <h3>Meus Documentos</h3>
                <div id="lista-documentos" style="max-height: 250px; overflow-y: auto; margin-top:15px;">
                    <p style="font-size: 0.8rem; color: #888;">Buscando arquivos...</p>
                </div>
                <button class="btn-action" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Atualizar Lista
                </button>
            </div>

            <div class="card">
                <i class="fab fa-whatsapp"></i>
                <h3>Suporte Direto</h3>
                <p style="font-size: 0.9rem;">Dúvidas? Fale com a contabilidade.</p>
                <button class="btn-action" style="background: #25d366;" onclick="abrirWhatsapp()">
                    Iniciar Chat
                </button>
            </div>
        </div>
    </main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="cliente.js"></script>

<script>
    const nomesServicos = {
        'abertura-mei': 'Abertura de MEI', 
        'mei-plano-basico': 'Plano MEI Básico', 
        'mei-plano-premium': 'Plano MEI Premium', 
        'irpf': 'Declaração IRPF',
        'regularizacao-mei': 'Regularização de MEI',
        'baixa-mei': 'Baixa de MEI',
        'emissao-das': 'Emissão de DAS',
        'dasn-anual': 'DASN (Anual)',
        'parcelamento-mei': 'Parcelamento de Débitos',
        'alteracao-mei': 'Alteração de Dados',
        'cpf-regularizacao': 'Regularização de CPF',
        'planejamento-tributario': 'Planejamento Tributário'
    };

    function abrirWhatsapp(msg = "Olá! Sou cliente JL e preciso de suporte.") {
        window.open(`https://wa.me/5561920041427?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function carregarDadosDashboard(user) {
        try {
            // --- FORÇAR ATUALIZAÇÃO DO NOME NO PERFIL ---
            // Como o usuário está logado aqui, as políticas de RLS 'authenticated' permitem o UPDATE.
            // Isso corrige o problema de usuários novos ou antigos que ficaram com "Novo Cliente".
            const realName = user.user_metadata?.full_name || user.user_metadata?.display_name;
            if (realName && realName.toLowerCase() !== "novo cliente") {
                await supabaseClient
                    .from('profiles')
                    .update({ nome: realName })
                    .eq('id', user.id);
            }

            const [resProfile, resAssinaturas, resDocs] = await Promise.all([
                supabaseClient.from('profiles').select('*').eq('id', user.id).maybeSingle(),
                supabaseClient.from('assinaturas').select('*').eq('cliente_id', user.id).order('created_at', { ascending: false }),
                supabaseClient.from('documentos').select('*').eq('cliente_id', user.id).order('created_at', { ascending: false })
            ]);

            const profile = resProfile.data;
            const assinaturas = resAssinaturas.data || [];
            const docs = resDocs.data || [];

            // --- LÓGICA DE NOME ---
            let finalName = profile?.nome || user.user_metadata?.full_name || user.email?.split('@')[0] || "Cliente";
            if (finalName.toLowerCase() === "novo cliente") finalName = user.email?.split('@')[0] || "Cliente";

            document.getElementById('user-name').innerText = "Olá, " + finalName;
            document.getElementById('user-email').innerText = user.email;

            // --- LISTA DE SERVIÇOS ---
            const listaServicos = document.getElementById('lista-servicos');
            if (assinaturas.length > 0) {
                listaServicos.innerHTML = assinaturas.map(sub => {
                    const status = sub.status || "Pendente";
                    const cor = status === 'Ativo' ? '#25d366' : (status === 'Pendente' ? '#f1c40f' : '#ff4444');
                    const corTexto = status === 'Pendente' ? 'black' : 'white';
                    const podeCancel = (status === 'Ativo' || status === 'Pendente');
                    const btnCancel = podeCancel ? `<button class="btn-cancel" onclick="abrirModalCancelamento('${sub.id}', '${nomesServicos[sub.plano_id] || sub.plano_id}')">Cancelar</button>` : '';
                    return `
                        <div class="service-item">
                            <div>
                                <p style="margin:0; font-weight:bold; font-size:0.9rem;">${nomesServicos[sub.plano_id] || sub.plano_id}</p>
                                <span class="status-badge" style="background:${cor}; color:${corTexto}; font-size:0.6rem;">${status}</span>
                            </div>
                            ${btnCancel}
                        </div>
                    `;
                }).join('');
            } else {
                listaServicos.innerHTML = "<p style='font-size:0.8rem; color:#888;'>Nenhum serviço contratado ainda.</p>";
            }

            // --- LISTA DE DOCUMENTOS ---
            const listaDocs = document.getElementById('lista-documentos');
            if (docs.length > 0) {
                listaDocs.innerHTML = docs.map(doc => `
                    <div class="doc-item">
                        <span style="font-size:0.8rem;"><i class="far fa-file-pdf" style="color:#ff4444;"></i> ${doc.nome_arquivo}</span>
                        <a href="${doc.url_arquivo}" target="_blank" style="color:var(--gold); text-decoration:none; font-size:0.7rem; font-weight:bold;">BAIXAR</a>
                    </div>
                `).join('');
            } else {
                listaDocs.innerHTML = "<p style='font-size:0.7rem; color:#666;'>Nada disponível ainda.</p>";
            }
        } catch (err) {
            console.error("Erro ao carregar dados:", err);
            document.getElementById('user-name').innerText = "Olá, Cliente";
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const user = await checkUser();
        if (user) {
            carregarDadosDashboard(user);
            const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com"; 
            if (user.email === EMAIL_ADMIN) {
                const btnAdmin = document.createElement('button');
                btnAdmin.innerHTML = '<i class="fas fa-user-shield"></i> Voltar ao Admin';
                btnAdmin.style = "position:fixed; bottom:20px; right:20px; background:#bd9617; color:white; border:none; padding:12px 20px; border-radius:30px; z-index:9999; cursor:pointer; font-weight:bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);";
                btnAdmin.onclick = () => window.location.href = '/servicos/area_do_cliente/admin.html';
                document.body.appendChild(btnAdmin);
            }
        }
    });
</script>
</body>
</html>
