<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Administrativa | JL Serviços</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #bd9617; --dark-blue: #0a192f; --glass: rgba(255, 255, 255, 0.05); --success: #25d366; }
        body { background: var(--dark-blue); color: white; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: rgba(0,0,0,0.4); border-right: 1px solid rgba(189, 150, 23, 0.2); padding: 30px 20px; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        h1, h2 { font-family: 'Playfair Display', serif; color: var(--gold); }
        .admin-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: var(--gold); border-bottom: 1px solid rgba(189, 150, 23, 0.3); padding: 12px; }
        td { padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .status-select { background: #1a2a44; color: white; border: 1px solid var(--gold); padding: 5px; border-radius: 5px; }
        .btn-upload { background: var(--gold); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .btn-upload:hover { background: #a68414; }
        #upload-area { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #16243d; padding: 30px; border-radius: 15px; border: 1px solid var(--gold); z-index: 1000; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        .logout-btn { margin-top: auto; color: #ff4444; text-decoration: none; cursor: pointer; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .client-info { display: flex; flex-direction: column; gap: 4px; }
        .client-info strong { font-size: 1rem; color: #fff; }
        .client-info small { color: #888; font-size: 0.75rem; }
        .client-detail { color: var(--gold); font-size: 0.8rem; font-weight: 600; }
        
        /* Estilos dos Filtros */
        .filters-container { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.75rem; color: var(--gold); font-weight: 600; text-transform: uppercase; }
        .filter-input { background: #1a2a44; color: white; border: 1px solid rgba(189, 150, 23, 0.3); padding: 8px 12px; border-radius: 5px; font-family: inherit; font-size: 0.85rem; outline: none; min-width: 150px; }
        .filter-input:focus { border-color: var(--gold); }
        .btn-clear { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; align-self: flex-end; font-size: 0.85rem; transition: 0.3s; }
        .btn-clear:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2>JL Admin</h2>
        <p style="font-size: 0.8rem; color: #888; margin-bottom: 30px;">Painel de Controle</p>
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <a href="#" style="color: var(--gold); text-decoration: none;"><i class="fas fa-users"></i> Gerenciar Clientes</a>
            <a href="../../index.html" style="color: white; text-decoration: none;"><i class="fas fa-eye"></i> Ver Site</a>
        </div>
        <a onclick="logout()" class="logout-btn"><i class="fas fa-power-off"></i> Sair</a>
    </aside>

    <main class="main-content">
        <h1>Painel Administrativo</h1>
        <p>Olá, <span id="admin-name">JL Serviços Contábeis Online</span>. Aqui estão os seus clientes e pedidos.</p>

        <div class="admin-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Clientes e Assinaturas</h3>
                <div id="counter-info" style="font-size: 0.85rem; color: #888;"></div>
            </div>

            <!-- Filtros -->
            <div class="filters-container">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filter-status" class="filter-input">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Cancelado">Cancelado</option>
                        <option value="POTENCIAL">Potencial (Sem Pedido)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Serviço</label>
                    <select id="filter-servico" class="filter-input">
                        <option value="">Todos os Serviços</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Data de Envio</label>
                    <input type="date" id="filter-data" class="filter-input">
                </div>
                <div class="filter-group" style="flex-grow: 1;">
                    <label>Buscar Cliente (Nome/Email/CPF)</label>
                    <input type="text" id="filter-search" class="filter-input" placeholder="Digite para buscar...">
                </div>
                <button class="btn-clear" onclick="limparFiltros()">Limpar</button>
            </div>

            <table id="table-clientes">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Serviço</th>
                        <th>Status</th>
                        <th>Data Envio</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-clientes-body">
                    <tr><td colspan="5" style="text-align:center;">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="fecharModal()"></div>
    <div id="upload-area">
        <h3 id="modal-title">Subir Documento</h3>
        <input type="file" id="file-input" accept=".pdf" style="margin-bottom: 20px;"><br>
        <button class="btn-upload" onclick="executarUpload()">Confirmar Envio</button>
        <button onclick="fecharModal()" style="background:none; border:none; color:white; cursor:pointer; margin-left:10px;">Cancelar</button>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="cliente.js"></script>

<script>
    let clienteSelecionado = null;
    let dadosOriginais = { profiles: [], assinaturas: [] };

    const nomesServicos = {
        'abertura-mei': 'Abertura de MEI', 
        'mei-plano-basico': 'Plano MEI Básico', 
        'mei-plano-premium': 'Plano MEI Premium', 
        'irpf': 'Declaração IRPF',
        'regularizacao-mei': 'Regularização de MEI',
        'baixa-mei': 'Baixa de MEI',
        'emissao-das': 'Emissão de DAS',
        'dasn-anual': 'DASN (Anual)',
        'parcelamento-mei': 'Parcelamento de Débitos',
        'alteracao-mei': 'Alteração de Dados',
        'cpf-regularizacao': 'Regularização de CPF',
        'planejamento-tributario': 'Planejamento Tributário',
        'basico': 'Plano MEI Básico',
        'premium': 'Plano MEI Premium',
        'mei-abertura': 'Abertura de MEI',
        'mei-regularizacao': 'Regularização de MEI',
        'mei-baixa': 'Baixa de MEI',
        'mei-emissao-das': 'Emissão de DAS',
        'mei-dasn': 'DASN (Anual)',
        'mei-parcelamento': 'Parcelamento de Débitos',
        'mei-alteracao': 'Alteração de Dados',
        'encerramento-mei': 'Encerramento de MEI',
        'dasn': 'DASN (Anual)',
        'parcelamento': 'Parcelamento de Débitos',
        'consultoria-contabil': 'Consultoria Contábil',
        'elaboracao-balanco': 'Elaboração de Balanço',
        'regularizacao-empresa': 'Regularização de Empresa',
        'encerramento-empresa': 'Encerramento de Empresa',
        'certidao-negativa': 'Certidão Negativa',
        'certidao-estadual': 'Certidão Estadual',
        'regularizacao-cadastral': 'Regularização Cadastral',
        'emissao-a1': 'Certificado Digital A1',
        'emissao-a3': 'Certificado Digital A3',
        'planilha-financeira': 'Planilha Financeira',
        'organizacao-documentos': 'Organização de Documentos',
        'orientacao-financeira': 'Orientação Financeira',
        'abertura-mei': 'Abertura de MEI',
        'regularizacao-mei': 'Regularização de MEI',
        'baixa-mei': 'Baixa de MEI',
        'emissao-das': 'Emissão de DAS',
        'irpf': 'Imposto de Renda (IRPF)',
        'cpf-regularizacao': 'Regularização de CPF',
        'carne-leao': 'Carnê-Leão',
        'alteracao-contratual': 'Alteração Contratual',
        'abertura-empresa': 'Abertura de Empresa',
        'certidao-fgts': 'Certidão de FGTS',
        'certidao-trabalhista': 'Certidão Trabalhista (CNDT)',
        'certidao-debitos': 'Certidão de Débitos Previdenciários',
        'certificado-cpf': 'Certificado Digital e-CPF',
        'certificado-cnpj': 'Certificado Digital e-CNPJ',
        'renovacao-certificado': 'Renovação de Certificado Digital',
        'regularizacao-pendencias': 'Regularização de Pendências',
        'emissao-notas': 'Emissão de Notas Fiscais'
    };

    async function carregarDadosAdmin() {
        try {
            const resProfiles = await supabaseClient.from('profiles').select('*');
            const { data: assinaturas, error: errorAssinaturas } = await supabaseClient.from('assinaturas').select('*');

            if (errorAssinaturas) console.error("Erro ao carregar assinaturas:", errorAssinaturas.message);

            dadosOriginais.profiles = resProfiles.data?.filter(p => p.email !== 'jlservicoscontabeis0@gmail.com') || [];
            dadosOriginais.assinaturas = assinaturas || [];

            popularFiltroServicos();
            renderizarTabelaFiltrada();
            
            // Adicionar listeners para os filtros
            ['filter-status', 'filter-servico', 'filter-data', 'filter-search'].forEach(id => {
                document.getElementById(id).addEventListener('input', renderizarTabelaFiltrada);
            });

        } catch (err) {
            console.error("Erro ao carregar dados admin:", err);
            document.getElementById('lista-clientes-body').innerHTML = '<tr><td colspan="5" style="text-align:center; color:#ff4444;">Erro ao carregar dados. Verifique o console.</td></tr>';
        }
    }

    function popularFiltroServicos() {
        const select = document.getElementById('filter-servico');
        const servicosUnicos = new Set();
        dadosOriginais.assinaturas.forEach(s => {
            const nome = nomesServicos[s.plano_id] || s.plano_id;
            if (nome) servicosUnicos.add(nome);
        });

        select.innerHTML = '<option value="">Todos os Serviços</option>';
        Array.from(servicosUnicos).sort().forEach(serv => {
            const opt = document.createElement('option');
            opt.value = serv;
            opt.textContent = serv;
            select.appendChild(opt);
        });
    }

    function renderizarTabelaFiltrada() {
        const statusFiltro = document.getElementById('filter-status').value;
        const servicoFiltro = document.getElementById('filter-servico').value;
        const dataFiltro = document.getElementById('filter-data').value;
        const buscaFiltro = document.getElementById('filter-search').value.toLowerCase();

        const body = document.getElementById('lista-clientes-body');
        body.innerHTML = '';

        let totalExibidos = 0;

        dadosOriginais.profiles.forEach(p => {
            const nomeExibicao = p.nome || p.email?.split('@')[0] || 'Usuário';
            const whatsapp = p.whatsapp || 'Não informado';
            const cpf = p.cpf_cnpj || 'Não informado';
            const email = p.email || '';

            // Filtro de busca textual
            const atendeBusca = !buscaFiltro || 
                nomeExibicao.toLowerCase().includes(buscaFiltro) || 
                email.toLowerCase().includes(buscaFiltro) || 
                cpf.toLowerCase().includes(buscaFiltro);

            if (!atendeBusca) return;

            const clienteAssinaturas = dadosOriginais.assinaturas.filter(s => s.cliente_id === p.id);

            if (clienteAssinaturas.length === 0) {
                // Caso: Potencial (Sem Pedido)
                const atendeStatus = !statusFiltro || statusFiltro === 'POTENCIAL';
                const atendeServico = !servicoFiltro;
                const atendeData = !dataFiltro;

                if (atendeStatus && atendeServico && atendeData) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="client-info">
                                <strong>${nomeExibicao}</strong>
                                <small>${email}</small>
                                <span class="client-detail"><i class="fab fa-whatsapp"></i> ${whatsapp}</span>
                                <span class="client-detail"><i class="far fa-id-card"></i> ${cpf}</span>
                            </div>
                        </td>
                        <td><span style="color:#666;">Interessado / Sem Pedido</span></td>
                        <td><span class="status-badge" style="background:#f1c40f; color: black;">POTENCIAL</span></td>
                        <td style="color: #666;">---</td> 
                        <td><button class="btn-upload" onclick="abrirModal('${p.id}', '${nomeExibicao}')"><i class="fas fa-upload"></i> Doc</button></td>
                    `;
                    body.appendChild(row);
                    totalExibidos++;
                }
            } else {
                // Caso: Com Pedidos
                clienteAssinaturas.forEach(sub => {
                    const nomeServico = nomesServicos[sub.plano_id] || sub.plano_id || 'Serviço';
                    const dataISO = sub.created_at ? sub.created_at.split('T')[0] : '';
                    const dataFormatada = sub.created_at ? new Date(sub.created_at).toLocaleDateString('pt-BR') : '---';

                    const atendeStatus = !statusFiltro || statusFiltro === sub.status;
                    const atendeServico = !servicoFiltro || servicoFiltro === nomeServico;
                    const atendeData = !dataFiltro || dataFiltro === dataISO;

                    if (atendeStatus && atendeServico && atendeData) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="client-info">
                                    <strong>${nomeExibicao}</strong>
                                    <small>${email}</small>
                                    <span class="client-detail"><i class="fab fa-whatsapp"></i> ${whatsapp}</span>
                                    <span class="client-detail"><i class="far fa-id-card"></i> ${cpf}</span>
                                </div>
                            </td>
                            <td>${nomeServico}</td>
                            <td>
                                <select class="status-select" onchange="atualizarStatus('${sub.id}', this.value)">
                                    <option value="Pendente" ${sub.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Ativo" ${sub.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                                    <option value="Cancelado" ${sub.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </td>
                            <td style="color: #aaa;">${dataFormatada}</td> 
                            <td><button class="btn-upload" onclick="abrirModal('${p.id}', '${nomeExibicao}')"><i class="fas fa-upload"></i> Doc</button></td>
                        `;
                        body.appendChild(row);
                        totalExibidos++;
                    }
                });
            }
        });

        document.getElementById('counter-info').textContent = `Exibindo ${totalExibidos} registro(s)`;
        if (totalExibidos === 0) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum resultado para os filtros aplicados.</td></tr>';
        }
    }

    function limparFiltros() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-servico').value = '';
        document.getElementById('filter-data').value = '';
        document.getElementById('filter-search').value = '';
        renderizarTabelaFiltrada();
    }

    async function atualizarStatus(subId, novoStatus) {
        if (!subId || subId === 'undefined' || subId === 'null') return alert("Cliente sem assinatura registrada.");
        
        try {
            const { error } = await supabaseClient
                .from('assinaturas')
                .update({ status: novoStatus })
                .eq('id', subId);
            
            if (error) throw error;
            
            // Atualizar os dados locais para refletir a mudança sem recarregar a página inteira
            const index = dadosOriginais.assinaturas.findIndex(s => s.id === subId);
            if (index !== -1) {
                dadosOriginais.assinaturas[index].status = novoStatus;
            }
            
            alert("Status atualizado com sucesso!");
            renderizarTabelaFiltrada();
        } catch (err) {
            console.error("Erro ao atualizar status:", err);
            alert("Erro ao atualizar status. Verifique o console.");
        }
    }

    function abrirModal(id, nome) {
        clienteSelecionado = id;
        document.getElementById('modal-title').innerText = "Upload para: " + nome;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('upload-area').style.display = 'block';
    }

    function fecharModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('upload-area').style.display = 'none';
    }

    async function executarUpload() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        const btn = document.querySelector('#upload-area .btn-upload');

        if (!file || !clienteSelecionado) return alert("Por favor, selecione um arquivo PDF.");

        try {
            btn.disabled = true;
            btn.innerText = "Enviando...";
            const fileName = `${Date.now()}_${file.name}`;
            const filePath = `${clienteSelecionado}/${fileName}`;

            const { error: storageError } = await supabaseClient.storage.from('documentos').upload(filePath, file);
            if (storageError) throw storageError;

            const { data: { publicUrl } } = supabaseClient.storage.from('documentos').getPublicUrl(filePath);
            const { error: dbError } = await supabaseClient.from('documentos').insert({
                cliente_id: clienteSelecionado,
                nome_arquivo: file.name,
                url_arquivo: publicUrl
            });

            if (dbError) throw dbError;
            alert("✅ Documento disponibilizado com sucesso!");
            fileInput.value = "";
            fecharModal();
        } catch (err) {
            console.error(err);
            alert("Erro no processo: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirmar Envio";
        }
    }

    // Inicialização protegida para Admin
    document.addEventListener('DOMContentLoaded', async () => {
        const user = await checkUser();
        if (user) {
            const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com";
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();

            if (profile?.role !== 'admin' && user.email !== EMAIL_ADMIN) {
                window.location.replace('/servicos/area_do_cliente/dashboard.html');
            } else {
                carregarDadosAdmin();
            }
        }
    });
</script>
</body>
</html>
