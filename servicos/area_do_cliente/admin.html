<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Administrativa | JL Serviços</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #bd9617; --dark-blue: #0a192f; --glass: rgba(255, 255, 255, 0.05); --success: #25d366; }
        body { background: var(--dark-blue); color: white; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: rgba(0,0,0,0.4); border-right: 1px solid rgba(189, 150, 23, 0.2); padding: 30px 20px; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        h1, h2 { font-family: 'Playfair Display', serif; color: var(--gold); }
        .admin-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: var(--gold); border-bottom: 1px solid rgba(189, 150, 23, 0.3); padding: 12px; }
        td { padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .status-select { background: #1a2a44; color: white; border: 1px solid var(--gold); padding: 5px; border-radius: 5px; }
        .btn-upload { background: var(--gold); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .btn-upload:hover { background: #a68414; }
        #upload-area { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #16243d; padding: 30px; border-radius: 15px; border: 1px solid var(--gold); z-index: 1000; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        .logout-btn { margin-top: auto; color: #ff4444; text-decoration: none; cursor: pointer; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .client-info { display: flex; flex-direction: column; gap: 4px; }
        .client-info strong { font-size: 1rem; color: #fff; }
        .client-info small { color: #888; font-size: 0.75rem; }
        .client-detail { color: var(--gold); font-size: 0.8rem; font-weight: 600; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2>JL Admin</h2>
        <p style="font-size: 0.8rem; color: #888; margin-bottom: 30px;">Painel de Controle</p>
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <a href="#" style="color: var(--gold); text-decoration: none;"><i class="fas fa-users"></i> Gerenciar Clientes</a>
            <a href="../../index.html" style="color: white; text-decoration: none;"><i class="fas fa-eye"></i> Ver Site</a>
        </div>
        <a onclick="logout()" class="logout-btn"><i class="fas fa-power-off"></i> Sair</a>
    </aside>

    <main class="main-content">
        <h1>Painel Administrativo</h1>
        <p>Olá, <span id="admin-name">JL Serviços Contábeis Online</span>. Aqui estão os seus clientes e pedidos.</p>

        <div class="admin-card">
            <h3>Clientes e Assinaturas</h3>
            <table id="table-clientes">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Serviço</th>
                        <th>Status</th>
                        <th>Data Envio</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-clientes-body">
                    <tr><td colspan="5" style="text-align:center;">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="fecharModal()"></div>
    <div id="upload-area">
        <h3 id="modal-title">Subir Documento</h3>
        <input type="file" id="file-input" accept=".pdf" style="margin-bottom: 20px;"><br>
        <button class="btn-upload" onclick="executarUpload()">Confirmar Envio</button>
        <button onclick="fecharModal()" style="background:none; border:none; color:white; cursor:pointer; margin-left:10px;">Cancelar</button>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="cliente.js"></script>

<script>
    let clienteSelecionado = null;

    const nomesServicos = {
        'abertura-mei': 'Abertura de MEI', 
        'mei-plano-basico': 'Plano MEI Básico', 
        'mei-plano-premium': 'Plano MEI Premium', 
        'irpf': 'Declaração IRPF',
        'regularizacao-mei': 'Regularização de MEI',
        'baixa-mei': 'Baixa de MEI',
        'emissao-das': 'Emissão de DAS',
        'dasn-anual': 'DASN (Anual)',
        'parcelamento-mei': 'Parcelamento de Débitos',
        'alteracao-mei': 'Alteração de Dados',
        'cpf-regularizacao': 'Regularização de CPF',
        'planejamento-tributario': 'Planejamento Tributário',
        'basico': 'Plano MEI Básico',
        'premium': 'Plano MEI Premium',
        'mei-abertura': 'Abertura de MEI',
        'mei-regularizacao': 'Regularização de MEI',
        'mei-baixa': 'Baixa de MEI',
        'mei-emissao-das': 'Emissão de DAS',
        'mei-dasn': 'DASN (Anual)',
        'mei-parcelamento': 'Parcelamento de Débitos',
        'mei-alteracao': 'Alteração de Dados',
        'encerramento-mei': 'Encerramento de MEI',
        'dasn': 'DASN (Anual)',
        'parcelamento': 'Parcelamento de Débitos',
        'consultoria-contabil': 'Consultoria Contábil',
        'elaboracao-balanco': 'Elaboração de Balanço',
        'regularizacao-empresa': 'Regularização de Empresa',
        'encerramento-empresa': 'Encerramento de Empresa',
        'certidao-negativa': 'Certidão Negativa',
        'certidao-estadual': 'Certidão Estadual',
        'regularizacao-cadastral': 'Regularização Cadastral',
        'emissao-a1': 'Certificado Digital A1',
        'emissao-a3': 'Certificado Digital A3',
        'planilha-financeira': 'Planilha Financeira',
        'organizacao-documentos': 'Organização de Documentos',
        'orientacao-financeira': 'Orientação Financeira'
    };

    async function carregarDadosAdmin() {
        try {
            const resProfiles = await supabaseClient.from('profiles').select('*');
            const { data: assinaturas, error: errorAssinaturas } = await supabaseClient.from('assinaturas').select('*');

            if (errorAssinaturas) console.error("Erro ao carregar assinaturas:", errorAssinaturas.message);

            let profiles = resProfiles.data?.filter(p => p.email !== 'jlservicoscontabeis0@gmail.com') || [];

            const body = document.getElementById('lista-clientes-body');
            body.innerHTML = '';

            if (profiles.length > 0) {
                profiles.forEach(p => {
                    let nomeExibicao = p.nome || p.email?.split('@')[0] || 'Usuário';
                    let whatsapp = p.whatsapp || 'Não informado';
                    let cpf = p.cpf_cnpj || 'Não informado';
                    
                    // Buscar todas as assinaturas deste cliente vinculadas pelo cliente_id
                    const clienteAssinaturas = (assinaturas || []).filter(s => s.cliente_id === p.id);
                    
                    if (clienteAssinaturas.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="client-info">
                                    <strong>${nomeExibicao}</strong>
                                    <small>${p.email}</small>
                                    <span class="client-detail"><i class="fab fa-whatsapp"></i> ${whatsapp}</span>
                                    <span class="client-detail"><i class="far fa-id-card"></i> ${cpf}</span>
                                </div>
                            </td>
                            <td><span style="color:#666;">Interessado / Sem Pedido</span></td>
                            <td><span class="status-badge" style="background:#f1c40f; color: black;">POTENCIAL</span></td>
                            <td style="color: #666;">---</td> 
                            <td><button class="btn-upload" onclick="abrirModal('${p.id}', '${nomeExibicao}')"><i class="fas fa-upload"></i> Doc</button></td>
                        `;
                        body.appendChild(row);
                    } else {
                        clienteAssinaturas.forEach(sub => {
                            const dataFormatada = sub.created_at ? new Date(sub.created_at).toLocaleDateString('pt-BR') : '---';                
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <div class="client-info">
                                        <strong>${nomeExibicao}</strong>
                                        <small>${p.email}</small>
                                        <span class="client-detail"><i class="fab fa-whatsapp"></i> ${whatsapp}</span>
                                        <span class="client-detail"><i class="far fa-id-card"></i> ${cpf}</span>
                                    </div>
                                </td>
                                <td>${nomesServicos[sub.plano_id] || sub.plano_id || 'Serviço'}</td>
                                <td>
                                    <select class="status-select" onchange="atualizarStatus('${sub.id}', this.value)">
                                        <option value="Pendente" ${sub.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="Ativo" ${sub.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                                        <option value="Cancelado" ${sub.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                    </select>
                                </td>
                                <td style="color: #aaa;">${dataFormatada}</td> 
                                <td><button class="btn-upload" onclick="abrirModal('${p.id}', '${nomeExibicao}')"><i class="fas fa-upload"></i> Doc</button></td>
                            `;
                            body.appendChild(row);
                        });
                    }
                });
            } else {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum cliente encontrado.</td></tr>';
            }
        } catch (err) {
            console.error("Erro ao carregar dados admin:", err);
            document.getElementById('lista-clientes-body').innerHTML = '<tr><td colspan="5" style="text-align:center; color:#ff4444;">Erro ao carregar dados. Verifique o console.</td></tr>';
        }
    }

    async function atualizarStatus(subId, novoStatus) {
        if (!subId || subId === 'undefined' || subId === 'null') return alert("Cliente sem assinatura registrada.");
        const { error } = await supabaseClient.from('assinaturas').update({ status: novoStatus }).eq('id', subId);
        if (!error) alert("Status atualizado!");
    }

    function abrirModal(id, nome) {
        clienteSelecionado = id;
        document.getElementById('modal-title').innerText = "Upload para: " + nome;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('upload-area').style.display = 'block';
    }

    function fecharModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('upload-area').style.display = 'none';
    }

    async function executarUpload() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        const btn = document.querySelector('#upload-area .btn-upload');

        if (!file || !clienteSelecionado) return alert("Por favor, selecione um arquivo PDF.");

        try {
            btn.disabled = true;
            btn.innerText = "Enviando...";
            const fileName = `${Date.now()}_${file.name}`;
            const filePath = `${clienteSelecionado}/${fileName}`;

            const { error: storageError } = await supabaseClient.storage.from('documentos').upload(filePath, file);
            if (storageError) throw storageError;

            const { data: { publicUrl } } = supabaseClient.storage.from('documentos').getPublicUrl(filePath);
            const { error: dbError } = await supabaseClient.from('documentos').insert({
                cliente_id: clienteSelecionado,
                nome_arquivo: file.name,
                url_arquivo: publicUrl
            });

            if (dbError) throw dbError;
            alert("✅ Documento disponibilizado com sucesso!");
            fileInput.value = "";
            fecharModal();
        } catch (err) {
            console.error(err);
            alert("Erro no processo: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirmar Envio";
        }
    }

    // Inicialização protegida para Admin
    document.addEventListener('DOMContentLoaded', async () => {
        const user = await checkUser();
        if (user) {
            const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com";
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();

            if (profile?.role !== 'admin' && user.email !== EMAIL_ADMIN) {
                window.location.replace('/servicos/area_do_cliente/dashboard.html');
            } else {
                carregarDadosAdmin();
            }
        }
    });
</script>
</body>
</html>
