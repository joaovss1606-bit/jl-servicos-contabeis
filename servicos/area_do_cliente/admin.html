<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Administrativa | JL Serviços</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #bd9617; --dark-blue: #0a192f; --glass: rgba(255, 255, 255, 0.05); --success: #25d366; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--dark-blue); color: white; font-family: 'Montserrat', sans-serif; min-height: 100vh; }
        
        /* Header & Nav */
        header {
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(189, 150, 23, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .logo-area h2 { color: var(--gold); font-family: 'Playfair Display'; font-size: 1.5rem; }
        
        /* Menu Hambúrguer */
        .menu-toggle {
            display: flex;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            z-index: 1001;
        }
        .menu-toggle span {
            width: 30px;
            height: 3px;
            background: var(--gold);
            border-radius: 2px;
            transition: 0.3s;
        }
        .menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 6px); }
        .menu-toggle.active span:nth-child(2) { opacity: 0; }
        .menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -6px); }

        .nav-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(10, 25, 47, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(189, 150, 23, 0.3);
            padding: 80px 30px;
            transition: 0.4s ease-in-out;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 1000;
        }
        .nav-menu.active { right: 0; }
        .nav-menu a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            transition: 0.3s;
        }
        .nav-menu a:hover { background: rgba(189, 150, 23, 0.1); color: var(--gold); }
        .nav-menu a.active { background: rgba(189, 150, 23, 0.2); color: var(--gold); }
        .logout-btn { color: #ff4444 !important; margin-top: auto; border: 1px solid rgba(255, 68, 68, 0.2); cursor: pointer; }
        .logout-btn:hover { background: rgba(255, 68, 68, 0.1) !important; }

        /* Main Content */
        .main-content { padding: 40px 30px; max-width: 1400px; margin: 0 auto; }
        h1, h2 { font-family: 'Playfair Display', serif; color: var(--gold); }
        .admin-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; margin-bottom: 30px; overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 800px; }
        th { text-align: left; color: var(--gold); border-bottom: 1px solid rgba(189, 150, 23, 0.3); padding: 15px 12px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        
        /* Estilo unificado para Selects */
        select, .status-select, .filter-input { 
            background: #0a192f !important; 
            color: var(--gold) !important; 
            border: 1px solid var(--gold) !important; 
            padding: 8px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            outline: none;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }
        select option {
            background: #0a192f;
            color: var(--gold);
        }

        .btn-upload { background: var(--gold); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: 0.3s; }
        .btn-upload:hover { background: #a68414; transform: translateY(-2px); }
        
        /* Modais */
        #upload-area, #novo-pedido-area, #cancelamento-motivo-area { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a192f; padding: 35px; border-radius: 20px; border: 2px solid var(--gold); z-index: 2000; box-shadow: 0 20px 60px rgba(0,0,0,0.6); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--gold); margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(189, 150, 23, 0.3); padding: 12px; border-radius: 8px; outline: none; transition: 0.3s; }
        .form-group input:focus { border-color: var(--gold); background: rgba(255,255,255,0.1); }
        
        .services-list-admin { border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .service-option { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .service-option:last-child { border-bottom: none; }
        .service-option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--gold); }
        .service-option label { margin-bottom: 0; cursor: pointer; flex-grow: 1; font-size: 0.85rem; color: #ccc; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1500; backdrop-filter: blur(5px); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        
        .client-info { display: flex; flex-direction: column; gap: 4px; }
        .client-info strong { font-size: 0.95rem; color: #fff; }
        .client-info small { color: #888; font-size: 0.75rem; }
        
        /* Filtros */
        .filters-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 0.7rem; color: var(--gold); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        .btn-clear { background: rgba(255,255,255,0.1); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; align-self: flex-end; font-size: 0.85rem; font-weight: 600; }
        .btn-clear:hover { background: rgba(255,255,255,0.2); }

        @media (max-width: 768px) {
            .main-content { padding: 30px 20px; }
            .filters-container { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <h2>JL Admin</h2>
        </div>
        <div class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </header>

    <nav class="nav-menu" id="navMenu">
        <a href="../../index.html"><i class="fas fa-home"></i> Início</a>
        <a href="#" class="active"><i class="fas fa-users"></i> Gerenciar Clientes</a>
        <a onclick="logout()" class="logout-btn"><i class="fas fa-power-off"></i> Sair do Painel</a>
    </nav>

    <main class="main-content">
        <h1 style="font-size: 2.2rem; margin-bottom: 10px;">Painel Administrativo</h1>
        <p style="color: #888; margin-bottom: 40px;">Olá, <span id="admin-name" style="color: var(--gold); font-weight: 600;">JL Serviços Contábeis Online</span>. Gerencie seus clientes e pedidos.</p>

        <div class="admin-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h3 style="margin: 0; font-family: 'Playfair Display'; font-size: 1.5rem;">Clientes e Assinaturas</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="counter-info" style="font-size: 0.85rem; color: #888; font-weight: 600;"></div>
                    <button class="btn-upload" onclick="abrirModalNovoPedido()" style="background: #25d366; padding: 12px 20px;"><i class="fas fa-plus"></i> Novo Pedido</button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-container">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filter-status" class="filter-input">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Cancelado">Cancelado</option>
                        <option value="POTENCIAL">Potencial (Sem Pedido)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Serviço</label>
                    <select id="filter-servico" class="filter-input">
                        <option value="">Todos os Serviços</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Data de Envio</label>
                    <input type="date" id="filter-data" class="filter-input" style="background: rgba(0,0,0,0.2); color: white; border: 1px solid var(--gold); padding: 10px; border-radius: 8px;">
                </div>
                <div class="filter-group" style="grid-column: span 2;">
                    <label>Buscar Cliente (Nome/Email/CPF)</label>
                    <input type="text" id="filter-search" class="filter-input" placeholder="Digite para buscar..." style="background: rgba(0,0,0,0.2); color: white; border: 1px solid var(--gold); padding: 10px; border-radius: 8px;">
                </div>
                <button class="btn-clear" onclick="limparFiltros()">Limpar</button>
            </div>

            <table id="table-clientes">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Serviço</th>
                        <th>Status</th>
                        <th>Data Envio</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-clientes-body">
                    <tr><td colspan="5" style="text-align:center; padding: 40px; color: #888;">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="fecharModal()"></div>
    
    <div id="upload-area">
        <h3 id="modal-title" style="color: var(--gold); margin-bottom: 20px;">Subir Documento</h3>
        <div class="form-group">
            <label>Arquivo PDF</label>
            <input type="file" id="file-input" accept=".pdf">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn-upload" onclick="executarUpload()" style="flex: 1;">Confirmar Envio</button>
            <button onclick="fecharModal()" style="background:none; border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer; padding: 10px; border-radius: 8px; flex: 1;">Cancelar</button>
        </div>
    </div>

    <!-- Modal Novo Pedido -->
    <div id="novo-pedido-area">
        <h3 style="color: var(--gold); margin-bottom: 20px;">Cadastrar Novo Pedido</h3>
        <div class="form-group">
            <label>Nome do Cliente</label>
            <input type="text" id="novo-nome" placeholder="Nome Completo">
        </div>
        <div class="form-group">
            <label>E-mail do Cliente</label>
            <input type="email" id="novo-email" placeholder="email@exemplo.com">
        </div>
        <div class="form-group">
            <label>WhatsApp</label>
            <input type="text" id="novo-whatsapp" placeholder="(00) 00000-0000">
        </div>
        <div class="form-group">
            <label>CPF/CNPJ</label>
            <input type="text" id="novo-cpf" placeholder="000.000.000-00">
        </div>
        <div class="form-group">
            <label>Selecione os Serviços</label>
            <div id="lista-servicos-selecao" class="services-list-admin">
                <!-- Preenchido via JS -->
            </div>
        </div>
        <div style="margin-top: 25px; display: flex; gap: 10px;">
            <button class="btn-upload" id="btn-finalizar-pedido" onclick="finalizarPedidoAdmin()" style="flex: 1; background: #25d366;">Finalizar Pedido</button>
            <button onclick="fecharModalNovoPedido()" style="background:none; border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer; padding: 10px; border-radius: 8px; flex: 1;">Cancelar</button>
        </div>
    </div>

    <!-- Modal Motivo Cancelamento -->
    <div id="cancelamento-motivo-area">
        <h3 style="color: #ff4444; margin-bottom: 15px;">Justificativa de Cancelamento</h3>
        <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px; line-height: 1.5;">Selecione o motivo do cancelamento. O cliente verá este aviso no dashboard dele.</p>
        <div class="form-group">
            <label>Motivo</label>
            <select id="cancel-motivo-select" class="filter-input" style="width: 100%;">
                <option value="Serviço não prestado">Serviço não prestado</option>
                <option value="Não foi feito o pagamento">Não foi feito o pagamento</option>
                <option value="Documentação incompleta">Documentação incompleta</option>
                <option value="Pedido duplicado">Pedido duplicado</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn-upload" id="btn-confirmar-cancel-admin" onclick="confirmarCancelamentoAdmin()" style="flex: 1; background: #ff4444;">Confirmar Cancelamento</button>
            <button onclick="fecharModalCancelAdmin()" style="background:none; border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer; padding: 10px; border-radius: 8px; flex: 1;">Voltar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="cliente.js"></script>
    <script>
        const nomesServicos = {
            // MEI
            'abertura-mei': 'Abertura de MEI', 
            'mei-plano-basico': 'Plano MEI Básico', 
            'mei-plano-premium': 'Plano MEI Premium', 
            'regularizacao-mei': 'Regularização de MEI',
            'baixa-mei': 'Baixa de MEI',
            'emissao-das': 'Emissão de DAS',
            'dasn-anual': 'DASN (Anual)',
            'parcelamento-mei': 'Parcelamento de Débitos MEI',
            'alteracao-mei': 'Alteração de Dados MEI',
            'encerramento-mei': 'Encerramento de MEI',
            // Pessoa Física
            'irpf': 'Declaração IRPF',
            'cpf-regularizacao': 'Regularização de CPF',
            'carne-leao': 'Carnê-Leão',
            // Contábeis
            'consultoria-contabil': 'Consultoria Contábil',
            'regularizacao-empresa': 'Regularização de Empresa',
            'alteracao-contratual': 'Alteração Contratual',
            'abertura-empresa': 'Abertura de Empresa',
            'encerramento-empresa': 'Encerramento de Empresa',
            // Certidões
            'certidao-negativa': 'Certidão Negativa de Débitos',
            'certidao-fgts': 'Certidão de FGTS',
            'certidao-trabalhista': 'Certidão Trabalhista (CNDT)',
            'certidao-debitos': 'Certidão de Débitos Previdenciários',
            // Certificado Digital
            'certificado-cpf': 'Certificado Digital e-CPF',
            'certificado-cnpj': 'Certificado Digital e-CNPJ',
            'renovacao-certificado': 'Renovação de Certificado Digital',
            // Outros
            'regularizacao-pendencias': 'Regularização de Pendências',
            'emissao-notas': 'Emissão de Notas Fiscais',
            'planejamento-tributario': 'Planejamento Tributário'
        };

        // Menu Hambúrguer
        const menuToggle = document.getElementById('menuToggle');
        const navMenu = document.getElementById('navMenu');
        menuToggle.addEventListener('click', () => {
            menuToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        let dadosOriginais = { profiles: [], assinaturas: [] };
        let clienteSelecionado = null;

        async function carregarDadosAdmin() {
            try {
                const [resProfiles, resAssinaturas] = await Promise.all([
                    supabaseClient.from('profiles').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('assinaturas').select('*').order('created_at', { ascending: false })
                ]);

                // Filtrar para não mostrar o admin na lista de clientes
                const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com";
                dadosOriginais.profiles = (resProfiles.data || []).filter(p => p.email !== EMAIL_ADMIN && p.role !== 'admin');
                dadosOriginais.assinaturas = resAssinaturas.data || [];

                popularFiltroServicos();
                renderizarTabelaFiltrada();
            } catch (err) {
                console.error("Erro ao carregar dados:", err);
            }
        }

        function popularFiltroServicos() {
            const select = document.getElementById('filter-servico');
            select.innerHTML = '<option value="">Todos os Serviços</option>';
            const servicosUnicos = [...new Set(dadosOriginais.assinaturas.map(s => s.plano_id))];
            servicosUnicos.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = nomesServicos[id] || id;
                select.appendChild(opt);
            });
        }

        function renderizarTabelaFiltrada() {
            const statusFiltro = document.getElementById('filter-status').value;
            const servicoFiltro = document.getElementById('filter-servico').value;
            const dataFiltro = document.getElementById('filter-data').value;
            const buscaFiltro = document.getElementById('filter-search').value.toLowerCase();

            const tbody = document.getElementById('lista-clientes-body');
            tbody.innerHTML = '';

            let count = 0;

            dadosOriginais.profiles.forEach(p => {
                const assinaturasDoCliente = dadosOriginais.assinaturas.filter(s => s.cliente_id === p.id);
                
                if (assinaturasDoCliente.length === 0) {
                    if (statusFiltro === '' || statusFiltro === 'POTENCIAL') {
                        if (p.nome?.toLowerCase().includes(buscaFiltro) || p.email?.toLowerCase().includes(buscaFiltro) || p.cpf_cnpj?.includes(buscaFiltro)) {
                            adicionarLinhaTabela(p, null);
                            count++;
                        }
                    }
                    return;
                }

                assinaturasDoCliente.forEach(s => {
                    const matchStatus = !statusFiltro || s.status === statusFiltro;
                    const matchServico = !servicoFiltro || s.plano_id === servicoFiltro;
                    const matchData = !dataFiltro || s.created_at.startsWith(dataFiltro);
                    const matchBusca = !buscaFiltro || p.nome?.toLowerCase().includes(buscaFiltro) || p.email?.toLowerCase().includes(buscaFiltro) || p.cpf_cnpj?.includes(buscaFiltro);

                    if (matchStatus && matchServico && matchData && matchBusca && statusFiltro !== 'POTENCIAL') {
                        adicionarLinhaTabela(p, s);
                        count++;
                    }
                });
            });

            document.getElementById('counter-info').innerText = `${count} registro(s) encontrado(s)`;
            if (count === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: #888;">Nenhum resultado encontrado.</td></tr>';
        }

        function adicionarLinhaTabela(p, s) {
            const tbody = document.getElementById('lista-clientes-body');
            const tr = document.createElement('tr');
            
            const status = s ? s.status : 'POTENCIAL';
            const corStatus = status === 'Ativo' ? '#25d366' : (status === 'Pendente' ? '#f1c40f' : '#ff4444');
            const corTexto = status === 'Pendente' ? 'black' : 'white';

            tr.innerHTML = `
                <td>
                    <div class="client-info">
                        <strong>${p.nome || 'Sem Nome'}</strong>
                        <small>${p.email}</small>
                        <small>${p.whatsapp || 'Sem WhatsApp'} | ${p.cpf_cnpj || 'Sem CPF'}</small>
                    </div>
                </td>
                <td>${s ? (nomesServicos[s.plano_id] || s.plano_id) : '<span style="color:#888;">Sem pedido</span>'}</td>
                <td>
                    ${s ? `
                        <select class="status-select" onchange="atualizarStatus('${s.id}', this.value)">
                            <option value="Pendente" ${s.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="Ativo" ${s.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                            <option value="Cancelado" ${s.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    ` : `<span class="status-badge" style="background:#888; color:white;">POTENCIAL</span>`}
                </td>
                <td>${s ? new Date(s.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                <td>
                    <button class="btn-upload" onclick="abrirModal('${p.id}', '${p.nome}')"><i class="fas fa-upload"></i> Doc</button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        function limparFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-servico').value = '';
            document.getElementById('filter-data').value = '';
            document.getElementById('filter-search').value = '';
            renderizarTabelaFiltrada();
        }

        let idAssinaturaParaCancelar = null;

        async function atualizarStatus(subId, novoStatus) {
            if (novoStatus === 'Cancelado') {
                idAssinaturaParaCancelar = subId;
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('cancelamento-motivo-area').style.display = 'block';
                return;
            }

            try {
                const { error } = await supabaseClient.from('assinaturas').update({ status: novoStatus, motivo_cancelamento: null }).eq('id', subId);
                if (error) throw error;
                
                const index = dadosOriginais.assinaturas.findIndex(s => s.id === subId);
                if (index !== -1) {
                    dadosOriginais.assinaturas[index].status = novoStatus;
                    dadosOriginais.assinaturas[index].motivo_cancelamento = null;
                }
                alert("Status atualizado!");
                renderizarTabelaFiltrada();
            } catch (err) {
                alert("Erro ao atualizar.");
            }
        }

        async function confirmarCancelamentoAdmin() {
            const motivo = document.getElementById('cancel-motivo-select').value;
            const btn = document.getElementById('btn-confirmar-cancel-admin');
            
            if (!idAssinaturaParaCancelar) {
                alert("Erro: Nenhuma assinatura selecionada.");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerText = "Cancelando...";
                
                console.log("Tentando cancelar assinatura:", idAssinaturaParaCancelar, "com motivo:", motivo);

                const { data, error } = await supabaseClient
                    .from('assinaturas')
                    .update({ 
                        status: 'Cancelado', 
                        motivo_cancelamento: motivo 
                    })
                    .eq('id', idAssinaturaParaCancelar)
                    .select();

                if (error) {
                    console.error("Erro detalhado do Supabase:", error);
                    throw error;
                }
                
                console.log("Resposta do cancelamento:", data);

                // Atualizar dados locais
                const index = dadosOriginais.assinaturas.findIndex(s => s.id === idAssinaturaParaCancelar);
                if (index !== -1) {
                    dadosOriginais.assinaturas[index].status = 'Cancelado';
                    dadosOriginais.assinaturas[index].motivo_cancelamento = motivo;
                }

                alert("Pedido cancelado com sucesso!");
                fecharModalCancelAdmin();
                renderizarTabelaFiltrada();
            } catch (err) {
                console.error("Erro capturado no catch:", err);
                alert("Erro ao cancelar: " + (err.message || "Erro desconhecido. Verifique o console."));
            } finally {
                btn.disabled = false;
                btn.innerText = "Confirmar Cancelamento";
            }
        }

        function fecharModalCancelAdmin() {
            fecharModal();
            idAssinaturaParaCancelar = null;
            renderizarTabelaFiltrada();
        }

        function abrirModal(id, nome) {
            clienteSelecionado = id;
            document.getElementById('modal-title').innerText = "Upload para: " + nome;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('upload-area').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('novo-pedido-area').style.display = 'none';
            document.getElementById('cancelamento-motivo-area').style.display = 'none';
        }

        async function executarUpload() {
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files[0]) return alert("Selecione um arquivo.");
            
            const file = fileInput.files[0];
            const fileName = `${Date.now()}_${file.name}`;
            const filePath = `documentos/${clienteSelecionado}/${fileName}`;

            try {
                const { data, error } = await supabaseClient.storage.from('docs_clientes').upload(filePath, file);
                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage.from('docs_clientes').getPublicUrl(filePath);
                
                await supabaseClient.from('documentos').insert({
                    cliente_id: clienteSelecionado,
                    nome_arquivo: file.name,
                    url_arquivo: publicUrl
                });

                alert("Documento enviado!");
                fecharModal();
            } catch (err) {
                alert("Erro no upload.");
            }
        }

        function abrirModalNovoPedido() {
            const container = document.getElementById('lista-servicos-selecao');
            container.innerHTML = Object.entries(nomesServicos).map(([id, nome]) => `
                <div class="service-option">
                    <input type="checkbox" id="serv-${id}" value="${id}">
                    <label for="serv-${id}">${nome}</label>
                </div>
            `).join('');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('novo-pedido-area').style.display = 'block';
        }

        function fecharModalNovoPedido() { fecharModal(); }

        async function finalizarPedidoAdmin() {
            const nome = document.getElementById('novo-nome').value;
            const email = document.getElementById('novo-email').value;
            const whatsapp = document.getElementById('novo-whatsapp').value;
            const cpf = document.getElementById('novo-cpf').value;
            const selecionados = Array.from(document.querySelectorAll('#lista-servicos-selecao input:checked')).map(i => i.value);

            if (!nome || !email || selecionados.length === 0) return alert("Preencha nome, email e selecione ao menos um serviço.");

            const btn = document.getElementById('btn-finalizar-pedido');
            try {
                btn.disabled = true;
                btn.innerText = "Processando...";

                let { data: profile } = await supabaseClient.from('profiles').select('id').eq('email', email).maybeSingle();
                let clienteId = profile?.id;

                if (!clienteId) {
                    const tempId = crypto.randomUUID();
                    const { data: newProfile, error: pErr } = await supabaseClient.from('profiles').insert({
                        id: tempId, nome, email, whatsapp, cpf_cnpj: cpf, role: 'cliente'
                    }).select().single();
                    if (pErr) throw pErr;
                    clienteId = tempId;
                } else {
                    await supabaseClient.from('profiles').update({ nome, whatsapp, cpf_cnpj: cpf }).eq('id', clienteId);
                }

                const inserts = selecionados.map(s => ({ cliente_id: clienteId, plano_id: s, status: 'Pendente' }));
                await supabaseClient.from('assinaturas').insert(inserts);

                alert("Pedido finalizado com sucesso!");
                fecharModal();
                carregarDadosAdmin();
            } catch (err) {
                alert("Erro ao criar pedido.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Finalizar Pedido";
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkUser();
            if (user) {
                const EMAIL_ADMIN = "jlservicoscontabeis0@gmail.com";
                if (user.email !== EMAIL_ADMIN) {
                    const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
                    if (profile?.role !== 'admin') window.location.href = '/servicos/area_do_cliente/dashboard.html';
                }
                carregarDadosAdmin();
            }
        });

        document.getElementById('filter-status').addEventListener('change', renderizarTabelaFiltrada);
        document.getElementById('filter-servico').addEventListener('change', renderizarTabelaFiltrada);
        document.getElementById('filter-data').addEventListener('input', renderizarTabelaFiltrada);
        document.getElementById('filter-search').addEventListener('input', renderizarTabelaFiltrada);
    </script>
</body>
</html>
